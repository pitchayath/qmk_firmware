/**
 * Copyright 2022 Charly Delay <charly@codesink.dev> (@0xcharly)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#include QMK_KEYBOARD_H

enum custom_keycodes {
     #ifdef VIA_ENABLE
     TOG_MAC_LANG = USER00,
     #else
     TOG_MAC_LANG = SAFE_RANGE,
     #endif
     TOG_WIN_LANG,
     MAC_LOCK_SCREEN,
};

enum charybdis_keymap_layers {
    LAYER_MAC_EN = 0,
    LAYER_MAC_TH,
    LAYER_WIN_EN,
    LAYER_WIN_TH,
    LAYER_MAC_NAV,
    LAYER_WIN_NAV,
    LAYER_MAC_SYM,
    LAYER_WIN_SYM,
    LAYER_NUM,
    LAYER_UTIL,
    LAYER_TBALL,
};

/** \brief Automatically enable sniping-mode on the TBALL layer. */
#define CHARYBDIS_AUTO_SNIPING_ON_LAYER LAYER_TBALL

#ifdef CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_ENABLE
static uint16_t auto_pointer_layer_timer = 0;

#    ifndef CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_TIMEOUT_MS
#        define CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_TIMEOUT_MS 1000
#    endif // CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_TIMEOUT_MS

#    ifndef CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_THRESHOLD
#        define CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_THRESHOLD 8
#    endif // CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_THRESHOLD
#endif     // CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_ENABLE

// clang-format off
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [LAYER_MAC_EN] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       LT(LAYER_UTIL,KC_ESC), KC_Q,                      KC_W,            KC_F,            KC_P,               KC_B,                        KC_J,                  KC_L,            KC_U,            KC_Y,              KC_SCLN,              KC_BSLS,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_TAB,                LCTL_T(KC_A),              LOPT_T(KC_R),    LCMD_T(KC_S),    LSFT_T(KC_T),       KC_G,                        KC_M,                  RSFT_T(KC_N),    RCMD_T(KC_E),    ROPT_T(KC_I),      RCTL_T(KC_O),         KC_QUOT,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       QK_CAPS_WORD_TOGGLE,   LT(LAYER_TBALL,KC_Z),      KC_X,            KC_C,            KC_D,               KC_V,                        KC_K,                  KC_H,            KC_COMM,         KC_DOT,            KC_SLSH,              KC_ENT,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          DRGSCRL,         KC_SPC,             MO(LAYER_MAC_NAV),           MO(LAYER_MAC_SYM),         KC_BSPC
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_MAC_TH] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_TRNS,               KC_Q,                      KC_W,            KC_E,            KC_R,               KC_T,                         KC_Y,                 KC_U,            KC_I,            KC_O,              KC_P,                 KC_BSLS,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_TRNS,               LCTL_T(KC_A),              LOPT_T(KC_S),    LCMD_T(KC_D),    LSFT_T(KC_F),       KC_G,                         KC_H,                 RSFT_T(KC_J),    RCMD_T(KC_K),    ROPT_T(KC_L),      RCTL_T(KC_SCLN),      KC_QUOT,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                 KC_TRNS,                   KC_X,            KC_C,            KC_V,               KC_B,                         KC_N,                 KC_M,            KC_COMM,         KC_DOT,            KC_SLSH,              KC_TRNS,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         KC_TRNS,            KC_TRNS,                      KC_TRNS,              KC_TRNS
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_WIN_EN] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_TRNS,               KC_Q,                      KC_W,            KC_F,            KC_P,               KC_B,                         KC_J,                 KC_L,            KC_U,            KC_Y,              KC_SCLN,              KC_BSLS,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_TRNS,               LGUI_T(KC_A),              LALT_T(KC_R),    LCTL_T(KC_S),    LSFT_T(KC_T),       KC_G,                         KC_M,                 RSFT_T(KC_N),    RCTL_T(KC_E),    RALT_T(KC_I),      RGUI_T(KC_O),         KC_QUOT,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       QK_CAPS_WORD_TOGGLE,   KC_TRNS,                   KC_X,            KC_C,            KC_D,               KC_V,                         KC_K,                 KC_H,            KC_COMM,         KC_DOT,            KC_SLSH,              KC_TRNS, 
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         KC_TRNS,            MO(LAYER_WIN_NAV),            MO(LAYER_WIN_SYM),    KC_TRNS 
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_WIN_TH] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_TRNS,               KC_Q,                      KC_W,            KC_E,            KC_R,               KC_T,                         KC_Y,                 KC_U,            KC_I,            KC_O,              KC_P,                 KC_BSLS,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_TRNS,               LGUI_T(KC_A),              LALT_T(KC_S),    LCTL_T(KC_D),    LSFT_T(KC_F),       KC_G,                         KC_H,                 RSFT_T(KC_J),    RCTL_T(KC_K),    RALT_T(KC_L),      RGUI_T(KC_SCLN),      KC_QUOT,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                 KC_TRNS,                   KC_X,            KC_C,            KC_V,               KC_B,                         KC_N,                 KC_M,            KC_COMM,         KC_DOT,            KC_SLSH,              KC_TRNS,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         KC_TRNS,            KC_TRNS,                      KC_TRNS,              KC_TRNS
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_MAC_NAV] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       MAC_LOCK_SCREEN,        LCMD(KC_Q),               LCMD(KC_W),      LCMD(KC_F),      LCMD(KC_P),         LCMD(KC_B),                   KC_EQL,               KC_HOME,         KC_PGDN,         KC_PGUP,           KC_END,              KC_MINS,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       TOG_MAC_LANG,           LCMD(KC_A),               LCMD(KC_R),      LCMD(KC_S),      LCMD(KC_T),         LCMD(KC_G),                   LCMD(KC_GRV),         KC_LEFT,         KC_DOWN,         KC_UP,             KC_RGHT,             KC_GRV,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_CAPS,                LCMD(KC_Z),               LCMD(KC_X),      LCMD(KC_C),      LCMD(KC_D),         LCMD(KC_V),                   LCMD(KC_TAB),         LOPT(KC_LEFT),   LOPT(KC_DOWN),   LOPT(KC_UP),       LOPT(KC_RGHT),       KC_ENT,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         LSG(KC_4),          KC_NO,                        MO(LAYER_NUM),        LOPT(KC_BSPC)
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_WIN_NAV] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       LGUI(KC_L),             LCTL(KC_Q),               LCTL(KC_W),      LCTL(KC_F),      LCTL(KC_P),         LCTL(KC_B),                   KC_EQL,               KC_HOME,         KC_PGDN,         KC_PGUP,           KC_END,              KC_MINS,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       TOG_WIN_LANG,           LCTL(KC_A),               LCTL(KC_R),      LCTL(KC_S),      LCTL(KC_T),         LCTL(KC_G),                   LSA(KC_TAB),          KC_LEFT,         KC_DOWN,         KC_UP,             KC_RGHT,             KC_GRV,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_CAPS,                LCTL(KC_Z),               LCTL(KC_X),      LCTL(KC_C),      LCTL(KC_D),         LCTL(KC_V),                   LALT(KC_TAB),         LCTL(KC_LEFT),   LCTL(KC_DOWN),   LCTL(KC_UP),       LCTL(KC_RGHT),       KC_ENT,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         LCTL(KC_PSCR),      KC_NO,                        MO(LAYER_NUM),        LCTL(KC_BSPC)
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_MAC_SYM] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_TRNS,                KC_HASH,                  KC_PERC,         KC_ASTR,         KC_EXLM,            KC_AT,                        LGUI(KC_SPC),         LAG(KC_LEFT),    LAG(KC_RGHT),    LCTL(KC_MINS),     RCS(KC_END),         KC_DEL,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_CIRC,                  KC_LBRC,         KC_LCBR,         KC_LPRN,            KC_AMPR,                      LALT(KC_TAB),         LCMD(KC_LEFT),   LCMD(KC_RIGHT),  KC_NO,             KC_NO,               KC_NO,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_DLR,                   KC_RBRC,         KC_RCBR,         KC_RPRN,            KC_PIPE,                      KC_NO,                LCTL(KC_UP),     LCTL(KC_DOWN),   KC_NO,             KC_NO,               TO(LAYER_TBALL),
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         KC_NO,              KC_TRNS,                      KC_NO,                KC_NO
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_WIN_SYM] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_TRNS,                KC_HASH,                  KC_PERC,         KC_ASTR,         KC_EXLM,            KC_AT,                        LGUI(KC_S),           RCS(KC_TAB),     LCTL(KC_TAB),    LCTL(KC_MINS),     RCS(KC_END),         KC_DEL,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_CIRC,                  KC_LBRC,         KC_LCBR,         KC_LPRN,            KC_AMPR,                      LALT(KC_TAB),         LALT(KC_LEFT),   LALT(KC_RIGHT),  KC_NO,             KC_NO,               KC_NO,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_DLR,                   KC_RBRC,         KC_RCBR,         KC_RPRN,            KC_PIPE,                      LSA(KC_TAB),          KC_NO,           KC_NO,           KC_NO,             KC_NO,               TO(LAYER_TBALL),
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         KC_NO,              KC_TRNS,                      KC_NO,                KC_NO
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_NUM] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_TRNS,                KC_7,                     KC_5,            KC_3,            KC_1,               KC_9,                         KC_0,                 KC_2,            KC_4,            KC_6,              KC_8,                KC_DEL,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  OSM(MOD_LCTL),            OSM(MOD_LALT),   OSM(MOD_LGUI),   OSM(MOD_LSFT),      KC_F11,                       KC_F12,               OSM(MOD_RSFT),   OSM(MOD_RGUI),   OSM(MOD_RALT),     OSM(MOD_RCTL),       KC_NO,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_TRNS,                KC_F7 ,                   KC_F5,           KC_F3,           KC_F1,              KC_F9,                        KC_F10,               KC_F2,           KC_F4,           KC_F6,             KC_F8,               KC_ENT,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_TRNS,         KC_NO,              KC_TRNS,                      KC_NO,                KC_NO
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),

  [LAYER_UTIL] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       KC_NO,                  KC_NO,                    KC_NO,           KC_NO,           KC_NO,            KC_NO,                          KC_MNXT,              KC_NO,           KC_NO,            KC_NO,              KC_NO,             KC_VOLU,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_NO,                    KC_NO,           KC_NO,           KC_NO,            KC_NO,                          KC_MPRV,              KC_RSFT,         KC_RGUI,          KC_RALT,            KC_RCTL,           KC_VOLD,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_NO,                    KC_NO,           KC_NO,           KC_NO,            KC_NO,                          KC_MPLY,              KC_NO,           KC_MPRV,          KC_MNXT,            KC_MPLY,           KC_MUTE,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          KC_NO,         TO(LAYER_WIN_EN),   TO(LAYER_MAC_EN),               KC_NO,                KC_NO
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),


  [LAYER_TBALL] = LAYOUT(
  // ╭────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮ ╭─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
       TO(LAYER_MAC_EN),       KC_NO,                    KC_NO,           KC_NO,           S_D_MOD,            DPI_MOD,                      KC_NO,                KC_NO,           KC_NO,            KC_NO,              KC_NO,             TO(LAYER_MAC_EN),
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_NO,                    KC_NO,           DRGSCRL,         SNP_TOG,            SNIPING,                      KC_NO,                KC_RSFT,         KC_RGUI,          KC_RALT,            KC_RCTL,           SNP_TOG,
  // ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
       KC_NO,                  KC_NO,                    KC_NO,           KC_NO,           S_D_RMOD,           DPI_RMOD,                     KC_NO,                KC_NO,           KC_NO,            KC_NO,              KC_NO,             DRG_TOG,
  // ╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
                                                                          DRG_TOG,         KC_BTN1,            KC_BTN2,                      KC_BTN2,              KC_BTN1
  //                                                  ╰───────────────────────────────────────────────────────────────────────────────╯ ╰──────────────────────────────────────────╯
  ),
};
// clang-format on

#ifdef POINTING_DEVICE_ENABLE
#    ifdef CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_ENABLE
report_mouse_t pointing_device_task_user(report_mouse_t mouse_report) {
    if (abs(mouse_report.x) > CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_THRESHOLD || abs(mouse_report.y) > CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_THRESHOLD) {
        if (auto_pointer_layer_timer == 0) {
            layer_on(LAYER_POINTER);
#        ifdef RGB_MATRIX_ENABLE
            rgb_matrix_mode_noeeprom(RGB_MATRIX_NONE);
            rgb_matrix_sethsv_noeeprom(HSV_GREEN);
#        endif // RGB_MATRIX_ENABLE
        }
        auto_pointer_layer_timer = timer_read();
    }
    return mouse_report;
}

void matrix_scan_user(void) {
    if (auto_pointer_layer_timer != 0 && TIMER_DIFF_16(timer_read(), auto_pointer_layer_timer) >= CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_TIMEOUT_MS) {
        auto_pointer_layer_timer = 0;
        layer_off(LAYER_POINTER);
#        ifdef RGB_MATRIX_ENABLE
        rgb_matrix_mode_noeeprom(RGB_MATRIX_DEFAULT_MODE);
#        endif // RGB_MATRIX_ENABLE
    }
}
#    endif // CHARYBDIS_AUTO_POINTER_LAYER_TRIGGER_ENABLE

#    ifdef CHARYBDIS_AUTO_SNIPING_ON_LAYER
layer_state_t layer_state_set_user(layer_state_t state) {
    charybdis_set_pointer_sniping_enabled(layer_state_cmp(state, CHARYBDIS_AUTO_SNIPING_ON_LAYER));
    return state;
}
#    endif // CHARYBDIS_AUTO_SNIPING_ON_LAYER
#endif     // POINTING_DEVICE_ENABLE

#ifdef RGB_MATRIX_ENABLE
// Forward-declare this helper function since it is defined in rgb_matrix.c.
void rgb_matrix_update_pwm_buffers(void);
#endif

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
     switch(keycode) {
          case TOG_MAC_LANG:
               if (record->event.pressed) {
                    tap_code16(LCTL(KC_SPC));
                    if (IS_LAYER_ON(LAYER_MAC_EN)) {
                         layer_move(LAYER_MAC_TH);
                    } else {
                         layer_move(LAYER_MAC_EN);
                    }
               }
               return false;
          case TOG_WIN_LANG:
               if (record->event.pressed) {
                    tap_code16(LGUI(KC_SPC));
                    if (IS_LAYER_ON(LAYER_WIN_EN)) {
                         layer_move(LAYER_WIN_TH);
                    } else {
                         layer_move(LAYER_WIN_EN);
                    }
               }
               return false;
          case MAC_LOCK_SCREEN:
               if (record->event.pressed) {
                    set_mods(MOD_LCTL | MOD_LGUI);
                    register_code(KC_Q);
               } else {
                    unregister_code(KC_Q);
                    clear_mods();
               }
               return false;
     }
     return true;
}